<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Share Your Location</title>
  <style>
    :root { color-scheme: light dark; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      margin: 0; padding: 24px;
      display: grid; place-items: center; min-height: 100dvh;
      background: canvas; color: canvastext;
    }
    .card {
      width: min(520px, 100%);
      border: 1px solid color-mix(in oklab, canvastext 15%, transparent);
      border-radius: 12px; padding: 20px 18px;
      box-shadow: 0 6px 24px rgba(0,0,0,.08);
      background: canvas;
    }
    h1 { font-size: 1.15rem; margin: 0 0 10px; }
    p { margin: 0 0 14px; line-height: 1.4; }
    .actions { display: flex; gap: 10px; margin-top: 10px; }
    button {
      appearance: none; border: 0; border-radius: 10px;
      padding: 10px 14px; cursor: pointer; font-weight: 600;
    }
    .primary { background: #2563eb; color: #fff; }
    .ghost { background: transparent; color: inherit; border: 1px solid color-mix(in oklab, canvastext 25%, transparent); }
    .muted { font-size: .9rem; color: color-mix(in oklab, canvastext 60%, transparent); }
    .status { margin-top: 12px; font-size: .95rem; }
    code.inline { font-family: ui-monospace, Menlo, Consolas, monospace; padding: 0 .25em; border-radius: 4px; background: color-mix(in oklab, canvastext 6%, canvas); }
  </style>
</head>
<body>
  <div class="card" role="dialog" aria-labelledby="title" aria-modal="true">
    <h1 id="title">Share your location</h1>
    <p>We’ll ask your browser for your current location and securely send it back to the assistant. This is optional.</p>
    <div class="actions">
      <button id="shareBtn" class="primary">Share my location</button>
      <button id="cancelBtn" class="ghost">Not now</button>
    </div>
    <div id="status" class="status muted" aria-live="polite"></div>
  </div>

  <script>
    // --------- Messaging helpers to communicate with Cognigy host ----------
    function sendToParent(message) {
      // You can restrict the target origin to your Cognigy Webchat origin if desired.
      window.parent?.postMessage(message, "*");
    }

    function resolveXApp(payload) {
      // Common contract: tell host we’re done with a result payload.
      sendToParent({
        type: "xApp.result",         // widely used pattern for Cognigy xApps
        payload,                     // your data
        source: "xapp-geolocation"   // helpful for debugging
      });
    }

    function closeXApp() {
      // Ask host to close the xApp (Cognigy Webchat typically listens for this)
      sendToParent({ type: "xApp.close", source: "xapp-geolocation" });
    }

    function resolveAndClose(payload) {
      resolveXApp(payload);
      // Give the host a moment to handle the result before requesting close
      setTimeout(closeXApp, 50);
    }

    // ------------------- Geolocation logic & UI wiring ---------------------
    const shareBtn  = document.getElementById("shareBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const statusEl  = document.getElementById("status");

    function setStatus(text) {
      statusEl.textContent = text;
    }

    function nowIso(ts) {
      try { return new Date(ts || Date.now()).toISOString(); } catch { return null; }
    }

    function handleSuccess(position) {
      const { latitude, longitude, accuracy, altitude, altitudeAccuracy, heading, speed } =
        position.coords || {};
      const payload = {
        ok: true,
        permission: "granted",
        coords: {
          latitude,
          longitude,
          accuracy,              // meters
          altitude,              // may be null
          altitudeAccuracy,      // meters (may be null)
          heading,               // degrees (may be null)
          speed                  // m/s (may be null)
        },
        timestamp: position.timestamp || Date.now(),
        timestampISO: nowIso(position.timestamp)
      };
      setStatus("Location captured. Sending back to the assistant…");
      resolveAndClose(payload);
    }

    function handleError(error) {
      // See https://developer.mozilla.org/en-US/docs/Web/API/GeolocationPositionError
      let reason = "unknown";
      switch (error?.code) {
        case 1: reason = "permission_denied"; break;
        case 2: reason = "position_unavailable"; break;
        case 3: reason = "timeout"; break;
      }
      const payload = {
        ok: false,
        permission: reason === "permission_denied" ? "denied" : "prompt", // best-effort
        error: {
          code: error?.code ?? null,
          name: error?.name ?? "GeolocationError",
          reason,
          message: error?.message ?? "Failed to fetch geolocation."
        },
        timestamp: Date.now(),
        timestampISO: nowIso()
      };
      setStatus("Unable to get location (" + reason.replaceAll("_", " ") + "). Sending the error back…");
      resolveAndClose(payload);
    }

    async function requestPermissionState() {
      // Optional: Check current permission state to enhance UX
      if (!("permissions" in navigator) || !navigator.permissions?.query) return null;
      try {
        const status = await navigator.permissions.query({ name: "geolocation" });
        return status.state; // "granted" | "prompt" | "denied"
      } catch { return null; }
    }

    async function getLocation() {
      if (!("geolocation" in navigator)) {
        handleError({ code: 2, name: "GeolocationUnsupported", message: "Geolocation is not supported in this browser." });
        return;
      }

      const perm = await requestPermissionState();
      if (perm === "denied") {
        // No prompt will show; short-circuit with a clear error
        handleError({ code: 1, name: "GeolocationPermissionDenied", message: "Location permission denied by the user/agent." });
        return;
      }

      setStatus("Requesting your location…");
      // Options: you can tune for speed or precision depending on your use case
      const options = {
        enableHighAccuracy: true,    // may use GPS if available
        timeout: 10000,              // 10s timeout
        maximumAge: 0                // no cached positions
      };

      // Must be triggered by a user gesture (button click)
      navigator.geolocation.getCurrentPosition(handleSuccess, handleError, options);
    }

    shareBtn.addEventListener("click", getLocation);
    cancelBtn.addEventListener("click", () => {
      setStatus("Canceled. Letting the assistant know…");
      resolveAndClose({
        ok: false,
        permission: "prompt",
        error: {
          code: 0,
          name: "UserCanceled",
          reason: "user_canceled",
          message: "User canceled the location request."
        },
        timestamp: Date.now(),
        timestampISO: nowIso()
      });
    });

    // Optional: listen for pings from host or theme updates (handy for debugging)
    window.addEventListener("message", (evt) => {
      // console.debug("[xApp] message from parent:", evt.data);
    });
  </script>
</body>
</html>
